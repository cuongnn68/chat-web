<template>
  <div class="chat">
    <SideBar v-bind:rooms="rooms" 
              v-on:choose-room="loadMessRoom" 
              v-on:showpu-joinr="popJoinRoom=true"
              v-on:showpu-creater="popNewRoom=true"
              class="side-bar"/>
    <ChatMain v-on:send-mess="sendMess" v-bind:mess="mess" class="content"/>
    <div v-if="popJoinRoom" class="popup">
      <div class="frame">
        <h2 class="frame-c">Join Room</h2>
        <label class="lb">Room Id</label>
        <input v-model="joinRoomId" class="frame-c" type="text">
        <div class="btns">
          <button v-on:click="joinRoom">Join</button>
          <button v-on:click="popJoinRoom=false">Cancel</button>
        </div>
        <h4 class="error">{{joinError}}</h4>
      </div>
    </div>
    <div v-if="popNewRoom" class="popup">
      <div class="frame">
        <h2 class="frame-c">Create Room</h2>
        <label class="lb">Name</label>
        <input v-model="newRoomName" class="frame-c" type="text">
        <div class="btns">
          <button v-on:click="newRoom">Create</button>
          <button v-on:click="popNewRoom=false">Cancel</button>
        </div>
      </div>
    </div>
  </div>
</template>

<script>
import SideBar from '../components/chat/SideBar.vue';
import ChatMain from '../components/chat/ChatMain.vue';
// import {getRooms} from "../api/userAPI.js";
import * as uapi from "../api/userAPI.js";
// import {getRoomMess} from "../api/roomAPI.js";
// import {sendRoomMess} from "../api/roomAPI.js";
import * as rapi from "../api/roomAPI.js";
export default {
  name: "Chat",
  components: {
    SideBar,
    ChatMain,
  },
  data() {
    return {
      rooms: [],
      users: [],
      mess: [],
      typeChat: {},
      popJoinRoom:false,
      popNewRoom: false,
      joinRoomId: "",
      newRoomName: "",
      joinError: "",
    }
  },
  methods: {
    getData() {
      uapi.getRooms().then(res => res.json())
                    .then(val => this.rooms = val["$values"]);

    },
    loadMessRoom(roomId) {
      console.log("choose room " + roomId);
      this.typeChat = {
        type: "room",
        roomId: roomId,
      };
      console.log(this.typeChat);
      rapi.getRoomMess(roomId).then(res => res.json()
                .then(mess => this.mess = mess["$values"]))
      console.log(this.mess);
      console.log("hey");
      for(let i = 0; i<this.mess.length ; i++) {
        console.log(this.mess[i]["content"]);
      }
                                    //TODO add message
    },
    sendMess(mess) {
      console.log("sendMess");
      console.log(this.typeChat["type"]);
      if(this.typeChat["type"] === "room") {
        console.log("sendRoomMess");
        const userId = JSON.parse(localStorage.getItem("userInfo"))["id"];
        console.log(this.typeChat["roomId"]); // FIXME how the fuck this is messeage //FIXME how the actual fuck
        rapi.sendRoomMess(this.typeChat["roomId"], userId, mess)
            .then(res => {
              if(!res.ok) console.log(res.statusText)
            }).catch(e => console.log(e)); // TODO show error

      } 
    },
    newRoom() {
      if(!this.newRoomName) {
        console.log("//TODO create notice line")
        return;
      }
      uapi.newRoom(this.newRoomName)
        .then(res => {
          if(!res.ok) {
            res.json().then(err => {throw err;}).catch(console.log);
          }
        }).catch(e => console.log(e));
      this.getData();
      this.newRoomName = "";
      this.popNewRoom = false;
    },
    joinRoom() {
      console.log(this.joinRoomId);
      rapi.joinRoom(this.joinRoomId)
          .then(res => {
            if(!res.ok) this.joinError = "Cant join room " + this.joinRoomId;
            else this.joinError = "";
          });
      this.getData();
      this.joinRoomId = "";
      this.popJoinRoom = false; 
    }
  },
  created: function() { // RM same as created() {
    this.getData();
  }
}
</script>

<style scoped>
  .chat {
    display: flex;

  }
  .side-bar {
    flex: 1;
    max-width: 250px;
    background-color: aliceblue;
  }
  .content {
    flex: 3;
    /* background-color: red; */
  }
  .popup {
    position: fixed;
    height: 100%;
    width: 100%;
    background-color: #ffffffcc;

    display: flex;
    justify-content: center;
    align-items: center;
  }
  .frame {
    z-index: 300;
    background-color: white;
    border-color: #b15ebb;
    border-width: 3px;
    border-style: solid;
    border-radius: 10px;
    padding: 20px;

    display:flex;
    flex-direction: column;
  }
  .frame-c {
    margin: 0 0 10px;
  }
  .btns {
    display: flex;
    justify-content: space-evenly;
  }
  .lb {
    text-align: left;
    font-size: 0.9rem;
  }
</style>